# Source: Internal design notes (SCUDA + ComfyUI integration)
# Link: N/A (local ComfyUI custom node)
# Checked (UTC): 2025-11-24
# Version: 0.1.0

import os
from typing import Dict, Any

try:
    import torch
except Exception:
    torch = None


class SCUDAStatusNode:
    """
    Simple diagnostic node that reports SCUDA-related environment
    and CUDA availability inside ComfyUI.
    """

    @classmethod
    def INPUT_TYPES(cls) -> Dict[str, Dict[str, Any]]:
        return {
            "required": {}
        }

    RETURN_TYPES = ("STRING", "STRING", "STRING",)
    RETURN_NAMES = ("status", "scuda_server", "ld_preload",)
    FUNCTION = "run"
    CATEGORY = "SCUDA"

    def run(self):
        scuda_server = os.environ.get("SCUDA_SERVER", "")
        ld_preload = os.environ.get("LD_PRELOAD", "")

        cuda_available = None
        cuda_device = None
        if torch is not None:
            try:
                cuda_available = torch.cuda.is_available()
                if cuda_available and torch.cuda.device_count() > 0:
                    cuda_device = torch.cuda.get_device_name(0)
            except Exception as e:
                cuda_available = f"error: {e}"

        status_parts = []

        if scuda_server:
            status_parts.append(f"SCUDA_SERVER={scuda_server}")
        else:
            status_parts.append("SCUDA_SERVER not set")

        if ld_preload:
            status_parts.append(f"LD_PRELOAD={ld_preload}")
        else:
            status_parts.append("LD_PRELOAD not set")

        if cuda_available is True:
            if cuda_device:
                status_parts.append(f"CUDA available: {cuda_device}")
            else:
                status_parts.append("CUDA available: (device name unknown)")
        elif cuda_available is False:
            status_parts.append("CUDA NOT available")
        elif cuda_available is None:
            status_parts.append("torch not available or failed to import")
        else:
            status_parts.append(f"CUDA status: {cuda_available}")

        status_text = "\n".join(status_parts)

        return (status_text, scuda_server or "", ld_preload or "")


NODE_CLASS_MAPPINGS = {
    "SCUDAStatus": SCUDAStatusNode,
}

NODE_DISPLAY_NAME_MAPPINGS = {
    "SCUDAStatus": "SCUDA Status / Diagnostics",
}